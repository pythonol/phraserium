import{g as Y,u as D,d as y,aS as le,ac as G,a9 as ne,h as V,b as ae,b4 as ie,ba as se,bB as re,b7 as ue,bb as oe,bC as ce,bc as K,bD as fe,b6 as de,aT as me,B as H,bo as x,aJ as ve,ax as ge,N as pe,I as be,E as ye,G as s,F as d,Q as q,J as Fe,K as B,a3 as he,M as Se,b3 as ke,bE as X}from"./index.js";import{Q as xe,a as Ce,b as _e,c as je}from"./QPage.js";import{b as P,a as J,Q}from"./QItem.js";import{Q as Ve}from"./QChip.js";import{h as ze}from"./format.js";import{Q as Ae}from"./QList.js";import{u as Ne}from"./use-quasar.js";import"./QResizeObserver.js";function z(e,m,p,S){const r=[];return e.forEach(o=>{S(o)===!0?r.push(o):m.push({failedPropValidation:p,file:o})}),r}function I(e){e&&e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),G(e)}const Be={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},Pe=["rejected"];function Qe({editable:e,dnd:m,getFileInput:p,addFilesToQueue:S}){const{props:r,emit:o,proxy:f}=Y(),n=D(null),u=y(()=>r.accept!==void 0?r.accept.split(",").map(t=>(t=t.trim(),t==="*"?"*/":(t.endsWith("/*")&&(t=t.slice(0,t.length-1)),t.toUpperCase()))):null),v=y(()=>parseInt(r.maxFiles,10)),_=y(()=>parseInt(r.maxTotalSize,10));function j(t){if(e.value)if(t!==Object(t)&&(t={target:null}),t.target!==null&&t.target.matches('input[type="file"]')===!0)t.clientX===0&&t.clientY===0&&le(t);else{const h=p();h&&h!==t.target&&h.click(t)}}function w(t){e.value&&t&&S(null,t)}function E(t,h,A,N){let a=Array.from(h||t.target.files);const F=[],C=()=>{F.length!==0&&o("rejected",F)};if(r.accept!==void 0&&u.value.indexOf("*/")===-1&&(a=z(a,F,"accept",i=>u.value.some(g=>i.type.toUpperCase().startsWith(g)||i.name.toUpperCase().endsWith(g))),a.length===0))return C();if(r.maxFileSize!==void 0){const i=parseInt(r.maxFileSize,10);if(a=z(a,F,"max-file-size",g=>g.size<=i),a.length===0)return C()}if(r.multiple!==!0&&a.length!==0&&(a=[a[0]]),a.forEach(i=>{i.__key=i.webkitRelativePath+i.lastModified+i.name+i.size}),N===!0){const i=A.map(g=>g.__key);a=z(a,F,"duplicate",g=>i.includes(g.__key)===!1)}if(a.length===0)return C();if(r.maxTotalSize!==void 0){let i=N===!0?A.reduce((g,L)=>g+L.size,0):0;if(a=z(a,F,"max-total-size",g=>(i+=g.size,i<=_.value)),a.length===0)return C()}if(typeof r.filter=="function"){const i=r.filter(a);a=z(a,F,"filter",g=>i.includes(g))}if(r.maxFiles!==void 0){let i=N===!0?A.length:0;if(a=z(a,F,"max-files",()=>(i++,i<=v.value)),a.length===0)return C()}if(C(),a.length!==0)return a}function R(t){I(t),m.value!==!0&&(m.value=!0)}function c(t){G(t),(t.relatedTarget!==null||ne.is.safari!==!0?t.relatedTarget!==n.value:document.elementsFromPoint(t.clientX,t.clientY).includes(n.value)===!1)===!0&&(m.value=!1)}function T(t){I(t);const h=t.dataTransfer.files;h.length!==0&&S(null,h),m.value=!1}function U(t){if(m.value===!0)return V("div",{ref:n,class:`q-${t}__dnd absolute-full`,onDragenter:I,onDragover:I,onDragleave:c,onDrop:T})}return Object.assign(f,{pickFiles:j,addFiles:w}),{pickFiles:j,addFiles:w,onDragover:R,onDragleave:c,processFiles:E,getDndNode:U,maxFilesNumber:v,maxTotalSizeNumber:_}}const we=ae({name:"QFile",inheritAttrs:!1,props:{...re,...se,...Be,modelValue:[File,FileList,Array],append:Boolean,useChips:Boolean,displayValue:[String,Number],tabindex:{type:[String,Number],default:0},counterLabel:Function,inputClass:[Array,String,Object],inputStyle:[Array,String,Object]},emits:[...ie,...Pe],setup(e,{slots:m,emit:p,attrs:S}){const{proxy:r}=Y(),o=ue(),f=D(null),n=D(!1),u=oe(e),{pickFiles:v,onDragover:_,onDragleave:j,processFiles:w,getDndNode:E}=Qe({editable:o.editable,dnd:n,getFileInput:W,addFilesToQueue:M}),R=ce(e),c=y(()=>Object(e.modelValue)===e.modelValue?"length"in e.modelValue?Array.from(e.modelValue):[e.modelValue]:[]),T=y(()=>K(c.value)),U=y(()=>c.value.map(l=>l.name).join(", ")),t=y(()=>ze(c.value.reduce((l,b)=>l+b.size,0))),h=y(()=>({totalSize:t.value,filesNumber:c.value.length,maxFiles:e.maxFiles})),A=y(()=>({tabindex:-1,type:"file",title:"",accept:e.accept,capture:e.capture,name:u.value,...S,id:o.targetUid.value,disabled:o.editable.value!==!0})),N=y(()=>"q-file q-field--auto-height"+(n.value===!0?" q-file--dnd":"")),a=y(()=>e.multiple===!0&&e.append===!0);function F(l){const b=c.value.slice();b.splice(l,1),i(b)}function C(l){const b=c.value.indexOf(l);b!==-1&&F(b)}function i(l){p("update:modelValue",e.multiple===!0?l:l[0])}function g(l){l.keyCode===13&&me(l)}function L(l){(l.keyCode===13||l.keyCode===32)&&v(l)}function W(){return f.value}function M(l,b){const k=w(l,b,c.value,a.value),$=W();$!=null&&($.value=""),k!==void 0&&((e.multiple===!0?e.modelValue&&k.every(te=>c.value.includes(te)):e.modelValue===k[0])||i(a.value===!0?c.value.concat(k):k))}function O(){return[V("input",{class:[e.inputClass,"q-file__filler"],style:e.inputStyle})]}function Z(){if(m.file!==void 0)return c.value.length===0?O():c.value.map((b,k)=>m.file({index:k,file:b,ref:this}));if(m.selected!==void 0)return c.value.length===0?O():m.selected({files:c.value,ref:this});if(e.useChips===!0)return c.value.length===0?O():c.value.map((b,k)=>V(Ve,{key:"file-"+k,removable:o.editable.value,dense:!0,textColor:e.color,tabindex:e.tabindex,onRemove:()=>{F(k)}},()=>V("span",{class:"ellipsis",textContent:b.name})));const l=e.displayValue!==void 0?e.displayValue:U.value;return l.length!==0?[V("div",{class:e.inputClass,style:e.inputStyle,textContent:l})]:O()}function ee(){const l={ref:f,...A.value,...R.value,class:"q-field__input fit absolute-full cursor-pointer",onChange:M};return e.multiple===!0&&(l.multiple=!0),V("input",l)}return Object.assign(o,{fieldClass:N,emitValue:i,hasValue:T,inputRef:f,innerValue:c,floatingLabel:y(()=>T.value===!0||K(e.displayValue)),computedCounter:y(()=>{if(e.counterLabel!==void 0)return e.counterLabel(h.value);const l=e.maxFiles;return`${c.value.length}${l!==void 0?" / "+l:""} (${t.value})`}),getControlChild:()=>E("file"),getControl:()=>{const l={ref:o.targetRef,class:"q-field__native row items-center cursor-pointer",tabindex:e.tabindex};return o.editable.value===!0&&Object.assign(l,{onDragover:_,onDragleave:j,onKeydown:g,onKeyup:L}),V("div",l,[ee()].concat(Z()))}}),Object.assign(r,{removeAtIndex:F,removeFile:C,getNativeElement:()=>f.value}),fe(r,"nativeEl",()=>f.value),de(o)}});async function Te(){return{settings:H().settings,topics:await x.topics.where({byUser:1}).toArray(),entities:await x.entries.where({byUser:1}).toArray(),states:await x.states.toArray(),favorites:await x.favorites.toArray(),notes:await x.notes.toArray()}}function Oe(e){const m=H(),p=ve(),S=ge(),r=pe();if(e.settings)for(const o in m.settings)o in e.settings&&(m.settings[o]=e.settings[o]);e.topics&&(x.topics.bulkPut(e.topics),p.loadAll()),e.entities&&(x.entries.bulkPut(e.entities),S.loadSearchWords()),e.states&&x.states.bulkPut(e.favorites),e.favorites&&(x.favorites.bulkPut(e.favorites),r.loadAll()),e.notes&&x.notes.bulkPut(e.notes)}const Je={__name:"BackupPage",setup(e){const m=Ne(),p=D(null);async function S(){const f=JSON.stringify(await Te(),null,2),n=new Blob([f],{type:"application/json"}),u=document.createElement("a");u.href=URL.createObjectURL(n),u.download="phraserium-user-data.json",u.click(),URL.revokeObjectURL(u.href)}function r(){const f=new FileReader;f.onload=n=>{try{const u=JSON.parse(n.target.result);if(!u||!ke.object(u))throw new Error("Пустые или невалидные данные");o(u)}catch(u){X.error("Ошибка при чтении файла: "+u.message)}},f.readAsText(p.value)}function o(f){const n=v=>f[v].length||Object.keys(f[v]).length,u=Object.keys(f);m.dialog({message:"Выберите данные для восстановления:",options:{type:"checkbox",model:u.filter(v=>n(v)),items:u.map(v=>({label:`${v} (${n(v)})`,value:v}))},cancel:!0,persistent:!0}).onOk(v=>{if(v.length){const _={};v.forEach(j=>_[j]=f[j]),Oe(_),X.success("Данные загружены"),p.value=null}})}return(f,n)=>(ye(),be(Se,null,[s(_e,{elevated:""},{default:d(()=>[s(xe,null,{default:d(()=>[s(q,{flat:"",dense:"",round:"",icon:"arrow_back","aria-label":"Back",onClick:n[0]||(n[0]=u=>f.$router.back())}),s(Ce,null,{default:d(()=>n[2]||(n[2]=[Fe("div",{class:"absolute-center"},"Backup",-1)])),_:1})]),_:1})]),_:1}),s(je,{padding:""},{default:d(()=>[s(Ae,{bordered:"",padding:""},{default:d(()=>[s(P,{header:""},{default:d(()=>n[3]||(n[3]=[B("Backup пользовательских данных")])),_:1}),s(J,null,{default:d(()=>[s(Q,null,{default:d(()=>[s(P,null,{default:d(()=>n[4]||(n[4]=[B("Создать резервную копию")])),_:1}),s(P,{caption:""},{default:d(()=>n[5]||(n[5]=[B(" Будет создан и скачан файл .json со всеми пользовательскими данными ")])),_:1})]),_:1}),s(Q,{side:""},{default:d(()=>[s(q,{onClick:S,icon:"save_alt",label:"Backup",color:"primary"})]),_:1})]),_:1}),s(J,null,{default:d(()=>[s(Q,null,{default:d(()=>[s(P,null,{default:d(()=>n[6]||(n[6]=[B("Восстановить из резервной копии")])),_:1}),s(P,{caption:""},{default:d(()=>n[7]||(n[7]=[B(" Восстановление пользовательских данных из файла .json ")])),_:1})]),_:1})]),_:1}),s(J,null,{default:d(()=>[s(Q,null,{default:d(()=>[s(we,{modelValue:p.value,"onUpdate:modelValue":n[1]||(n[1]=u=>p.value=u),accept:".json","max-file-size":"1048576",label:p.value?void 0:"Выберите файл...",clearable:"",outlined:"",dense:""},{prepend:d(()=>[s(he,{name:"attach_file"})]),_:1},8,["modelValue","label"])]),_:1}),s(Q,{side:""},{default:d(()=>[s(q,{onClick:r,disable:!p.value,icon:"upload_file",label:"Restore",color:"primary"},null,8,["disable"])]),_:1})]),_:1})]),_:1})]),_:1})],64))}};export{Je as default};
