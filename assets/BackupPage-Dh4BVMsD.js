import{t as A,b as y,g as Z,aP as ue,ad as ee,a8 as oe,h as B,a as ce,bB as fe,ba as de,b5 as me,b7 as ge,bb as pe,bC as be,bD as ve,b6 as ye,bd as M,aQ as he,A as te,bh as ne,bi as ae,N as le,ax as Fe,_ as _e,G as ke,F as r,E as c,H as Se,b1 as X,bE as q,D as xe,W as $,I as je,a1 as Q,a6 as Ce}from"./index-BD0aB69o.js";import{Q as Be,a as Ve,b as Ne,c as Pe}from"./QPage-D2etE016.js";import{b as D,Q as W,a as O}from"./QItem-CJqT9T-U.js";import{Q as ze}from"./QChip-dQnJI08t.js";import{h as Qe}from"./format-CJebrXOQ.js";import{Q as De}from"./QList-Bn1p-wLU.js";import{u as Y}from"./use-quasar-Plz2atnA.js";import"./QResizeObserver-8tGYYoI4.js";function N(e,n,F,s){const u=[];return e.forEach(d=>{s(d)===!0?u.push(d):n.push({failedPropValidation:F,file:d})}),u}function I(e){e&&e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),ee(e)}const Oe={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},Ae=["rejected"];function we({editable:e,dnd:n,getFileInput:F,addFilesToQueue:s}){const{props:u,emit:d,proxy:b}=Z(),x=A(null),p=y(()=>u.accept!==void 0?u.accept.split(",").map(t=>(t=t.trim(),t==="*"?"*/":(t.endsWith("/*")&&(t=t.slice(0,t.length-1)),t.toUpperCase()))):null),_=y(()=>parseInt(u.maxFiles,10)),f=y(()=>parseInt(u.maxTotalSize,10));function m(t){if(e.value)if(t!==Object(t)&&(t={target:null}),t.target!==null&&t.target.matches('input[type="file"]')===!0)t.clientX===0&&t.clientY===0&&ue(t);else{const k=F();k&&k!==t.target&&k.click(t)}}function C(t){e.value&&t&&s(null,t)}function V(t,k,P,z){let l=Array.from(k||t.target.files);const h=[],j=()=>{h.length!==0&&d("rejected",h)};if(u.accept!==void 0&&p.value.indexOf("*/")===-1&&(l=N(l,h,"accept",i=>p.value.some(g=>i.type.toUpperCase().startsWith(g)||i.name.toUpperCase().endsWith(g))),l.length===0))return j();if(u.maxFileSize!==void 0){const i=parseInt(u.maxFileSize,10);if(l=N(l,h,"max-file-size",g=>g.size<=i),l.length===0)return j()}if(u.multiple!==!0&&l.length!==0&&(l=[l[0]]),l.forEach(i=>{i.__key=i.webkitRelativePath+i.lastModified+i.name+i.size}),z===!0){const i=P.map(g=>g.__key);l=N(l,h,"duplicate",g=>i.includes(g.__key)===!1)}if(l.length===0)return j();if(u.maxTotalSize!==void 0){let i=z===!0?P.reduce((g,U)=>g+U.size,0):0;if(l=N(l,h,"max-total-size",g=>(i+=g.size,i<=f.value)),l.length===0)return j()}if(typeof u.filter=="function"){const i=u.filter(l);l=N(l,h,"filter",g=>i.includes(g))}if(u.maxFiles!==void 0){let i=z===!0?P.length:0;if(l=N(l,h,"max-files",()=>(i++,i<=_.value)),l.length===0)return j()}if(j(),l.length!==0)return l}function T(t){I(t),n.value!==!0&&(n.value=!0)}function o(t){ee(t),(t.relatedTarget!==null||oe.is.safari!==!0?t.relatedTarget!==x.value:document.elementsFromPoint(t.clientX,t.clientY).includes(x.value)===!1)===!0&&(n.value=!1)}function w(t){I(t);const k=t.dataTransfer.files;k.length!==0&&s(null,k),n.value=!1}function R(t){if(n.value===!0)return B("div",{ref:x,class:`q-${t}__dnd absolute-full`,onDragenter:I,onDragover:I,onDragleave:o,onDrop:w})}return Object.assign(b,{pickFiles:m,addFiles:C}),{pickFiles:m,addFiles:C,onDragover:T,onDragleave:o,processFiles:V,getDndNode:R,maxFilesNumber:_,maxTotalSizeNumber:f}}const Ee=ce({name:"QFile",inheritAttrs:!1,props:{...fe,...de,...Oe,modelValue:[File,FileList,Array],append:Boolean,useChips:Boolean,displayValue:[String,Number],tabindex:{type:[String,Number],default:0},counterLabel:Function,inputClass:[Array,String,Object],inputStyle:[Array,String,Object]},emits:[...me,...Ae],setup(e,{slots:n,emit:F,attrs:s}){const{proxy:u}=Z(),d=ge(),b=A(null),x=A(!1),p=pe(e),{pickFiles:_,onDragover:f,onDragleave:m,processFiles:C,getDndNode:V}=we({editable:d.editable,dnd:x,getFileInput:H,addFilesToQueue:J}),T=be(e),o=y(()=>Object(e.modelValue)===e.modelValue?"length"in e.modelValue?Array.from(e.modelValue):[e.modelValue]:[]),w=y(()=>M(o.value)),R=y(()=>o.value.map(a=>a.name).join(", ")),t=y(()=>Qe(o.value.reduce((a,v)=>a+v.size,0))),k=y(()=>({totalSize:t.value,filesNumber:o.value.length,maxFiles:e.maxFiles})),P=y(()=>({tabindex:-1,type:"file",title:"",accept:e.accept,capture:e.capture,name:p.value,...s,id:d.targetUid.value,disabled:d.editable.value!==!0})),z=y(()=>"q-file q-field--auto-height"+(x.value===!0?" q-file--dnd":"")),l=y(()=>e.multiple===!0&&e.append===!0);function h(a){const v=o.value.slice();v.splice(a,1),i(v)}function j(a){const v=o.value.indexOf(a);v!==-1&&h(v)}function i(a){F("update:modelValue",e.multiple===!0?a:a[0])}function g(a){a.keyCode===13&&he(a)}function U(a){(a.keyCode===13||a.keyCode===32)&&_(a)}function H(){return b.value}function J(a,v){const S=C(a,v,o.value,l.value),L=H();L!=null&&(L.value=""),S!==void 0&&((e.multiple===!0?e.modelValue&&S.every(se=>o.value.includes(se)):e.modelValue===S[0])||i(l.value===!0?o.value.concat(S):S))}function E(){return[B("input",{class:[e.inputClass,"q-file__filler"],style:e.inputStyle})]}function ie(){if(n.file!==void 0)return o.value.length===0?E():o.value.map((v,S)=>n.file({index:S,file:v,ref:this}));if(n.selected!==void 0)return o.value.length===0?E():n.selected({files:o.value,ref:this});if(e.useChips===!0)return o.value.length===0?E():o.value.map((v,S)=>B(ze,{key:"file-"+S,removable:d.editable.value,dense:!0,textColor:e.color,tabindex:e.tabindex,onRemove:()=>{h(S)}},()=>B("span",{class:"ellipsis",textContent:v.name})));const a=e.displayValue!==void 0?e.displayValue:R.value;return a.length!==0?[B("div",{class:e.inputClass,style:e.inputStyle,textContent:a})]:E()}function re(){const a={ref:b,...P.value,...T.value,class:"q-field__input fit absolute-full cursor-pointer",onChange:J};return e.multiple===!0&&(a.multiple=!0),B("input",a)}return Object.assign(d,{fieldClass:z,emitValue:i,hasValue:w,inputRef:b,innerValue:o,floatingLabel:y(()=>w.value===!0||M(e.displayValue)),computedCounter:y(()=>{if(e.counterLabel!==void 0)return e.counterLabel(k.value);const a=e.maxFiles;return`${o.value.length}${a!==void 0?" / "+a:""} (${t.value})`}),getControlChild:()=>V("file"),getControl:()=>{const a={ref:d.targetRef,class:"q-field__native row items-center cursor-pointer",tabindex:e.tabindex};return d.editable.value===!0&&Object.assign(a,{onDragover:f,onDragleave:m,onKeydown:g,onKeyup:U}),B("div",a,[re()].concat(ie()))}}),Object.assign(u,{removeAtIndex:h,removeFile:j,getNativeElement:()=>b.value}),ve(u,"nativeEl",()=>b.value),ye(d)}});async function G(){return{settings:te().settings,topics:await ne.objects.where({byUser:1}).toArray(),entities:await ae.objects.where({byUser:1}).toArray(),notes:await le.objects.toArray()}}function K(e){const n=te(),F=Fe();if(e.settings)for(const s in n.settings)s in e.settings&&(n.settings[s]=e.settings[s]);e.topics&&ne.objects.bulkPut(e.topics),e.entities&&(ae.objects.bulkPut(e.entities),F.loadSearchWords()),e.notes&&le.objects.bulkPut(e.notes)}const Ie={__name:"BackupPage",setup(e,{expose:n}){n();const F=Y(),s=A(null);async function u(){const p=JSON.stringify(await G(),null,2),_=new Blob([p],{type:"application/json"}),f=document.createElement("a");f.href=URL.createObjectURL(_),f.download="phraserium-user-data.json",f.click(),URL.revokeObjectURL(f.href)}function d(){const p=new FileReader;p.onload=_=>{try{const f=JSON.parse(_.target.result);if(!f||!X.object(f))throw new Error("Пустые или невалидные данные");b(f)}catch(f){q.error("Ошибка при чтении файла: "+f.message)}},p.readAsText(s.value)}function b(p){const _=m=>p[m].length||Object.keys(p[m]).length,f=Object.keys(p);F.dialog({message:"Выберите данные для восстановления:",options:{type:"checkbox",model:f.filter(m=>_(m)),items:f.map(m=>({label:`${m} (${_(m)})`,value:m}))},cancel:!0,persistent:!0}).onOk(m=>{if(m.length){const C={};m.forEach(V=>C[V]=p[V]),K(C),q.success("Данные загружены"),s.value=null}})}const x={$q:F,file:s,onCreateBackup:u,onRestoreBackup:d,selectBackup:b,ref:A,get is(){return X},get useQuasar(){return Y},get getBackupData(){return G},get restoreData(){return K},get notify(){return q}};return Object.defineProperty(x,"__isScriptSetup",{enumerable:!1,value:!0}),x}};function Te(e,n,F,s,u,d){return xe(),ke(Se,null,[r(Be,{elevated:""},{default:c(()=>[r(Ne,null,{default:c(()=>[r($,{flat:"",dense:"",round:"",icon:"arrow_back","aria-label":"Back",onClick:n[0]||(n[0]=b=>e.$router.back())}),r(Pe,null,{default:c(()=>n[2]||(n[2]=[je("div",{class:"absolute-center"},"Backup",-1)])),_:1})]),_:1})]),_:1}),r(Ve,{padding:""},{default:c(()=>[r(De,{bordered:"",padding:""},{default:c(()=>[r(D,{header:""},{default:c(()=>n[3]||(n[3]=[Q("Backup пользовательских данных")])),_:1}),r(W,null,{default:c(()=>[r(O,null,{default:c(()=>[r(D,null,{default:c(()=>n[4]||(n[4]=[Q("Создать резервную копию")])),_:1}),r(D,{caption:""},{default:c(()=>n[5]||(n[5]=[Q(" Будет создан и скачан файл .json со всеми пользовательскими данными ")])),_:1})]),_:1}),r(O,{side:""},{default:c(()=>[r($,{onClick:s.onCreateBackup,icon:"save_alt",label:"Backup",color:"primary"})]),_:1})]),_:1}),r(W,null,{default:c(()=>[r(O,null,{default:c(()=>[r(D,null,{default:c(()=>n[6]||(n[6]=[Q("Восстановить из резервной копии")])),_:1}),r(D,{caption:""},{default:c(()=>n[7]||(n[7]=[Q(" Восстановление пользовательских данных из файла .json ")])),_:1})]),_:1})]),_:1}),r(W,null,{default:c(()=>[r(O,null,{default:c(()=>[r(Ee,{modelValue:s.file,"onUpdate:modelValue":n[1]||(n[1]=b=>s.file=b),accept:".json","max-file-size":"1048576",label:s.file?void 0:"Выберите файл...",clearable:"",outlined:"",dense:""},{prepend:c(()=>[r(Ce,{name:"attach_file"})]),_:1},8,["modelValue","label"])]),_:1}),r(O,{side:""},{default:c(()=>[r($,{onClick:s.onRestoreBackup,disable:!s.file,icon:"upload_file",label:"Restore",color:"primary"},null,8,["disable"])]),_:1})]),_:1})]),_:1})]),_:1})],64)}const Me=_e(Ie,[["render",Te],["__file","BackupPage.vue"]]);export{Me as default};
