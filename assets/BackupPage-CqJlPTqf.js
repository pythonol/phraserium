import{u as I,d as y,g as ee,aP as se,ac as te,a7 as re,h as V,b as ue,by as oe,b7 as ce,b2 as fe,b4 as de,b8 as me,bz as ge,bA as pe,b3 as ve,ba as M,aQ as be,B as ne,bh as x,aI as ye,aw as Fe,K as he,_ as ke,H as Se,G as r,F as f,I as _e,b0 as X,bB as $,E as xe,V as W,J as Ce,R as w,a5 as je}from"./index-DoEDWk-O.js";import{Q as Be,a as Ve,b as Pe,c as ze}from"./QPage-BA3If_qo.js";import{b as N,a as J,Q as O}from"./QItem-Ciz57iHY.js";import{Q as Ae}from"./QChip-Bc-z0VmF.js";import{h as Qe}from"./format-CJebrXOQ.js";import{Q as we}from"./QList-D9xKRHYq.js";import{u as Y}from"./use-quasar-C9lgzhIG.js";import"./QResizeObserver-YPPPox_a.js";function z(e,n,h,c){const s=[];return e.forEach(u=>{c(u)===!0?s.push(u):n.push({failedPropValidation:h,file:u})}),s}function R(e){e&&e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),te(e)}const Ne={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},Oe=["rejected"];function Ie({editable:e,dnd:n,getFileInput:h,addFilesToQueue:c}){const{props:s,emit:u,proxy:v}=ee(),C=I(null),p=y(()=>s.accept!==void 0?s.accept.split(",").map(t=>(t=t.trim(),t==="*"?"*/":(t.endsWith("/*")&&(t=t.slice(0,t.length-1)),t.toUpperCase()))):null),k=y(()=>parseInt(s.maxFiles,10)),d=y(()=>parseInt(s.maxTotalSize,10));function m(t){if(e.value)if(t!==Object(t)&&(t={target:null}),t.target!==null&&t.target.matches('input[type="file"]')===!0)t.clientX===0&&t.clientY===0&&se(t);else{const S=h();S&&S!==t.target&&S.click(t)}}function B(t){e.value&&t&&c(null,t)}function P(t,S,A,Q){let l=Array.from(S||t.target.files);const F=[],j=()=>{F.length!==0&&u("rejected",F)};if(s.accept!==void 0&&p.value.indexOf("*/")===-1&&(l=z(l,F,"accept",i=>p.value.some(g=>i.type.toUpperCase().startsWith(g)||i.name.toUpperCase().endsWith(g))),l.length===0))return j();if(s.maxFileSize!==void 0){const i=parseInt(s.maxFileSize,10);if(l=z(l,F,"max-file-size",g=>g.size<=i),l.length===0)return j()}if(s.multiple!==!0&&l.length!==0&&(l=[l[0]]),l.forEach(i=>{i.__key=i.webkitRelativePath+i.lastModified+i.name+i.size}),Q===!0){const i=A.map(g=>g.__key);l=z(l,F,"duplicate",g=>i.includes(g.__key)===!1)}if(l.length===0)return j();if(s.maxTotalSize!==void 0){let i=Q===!0?A.reduce((g,L)=>g+L.size,0):0;if(l=z(l,F,"max-total-size",g=>(i+=g.size,i<=d.value)),l.length===0)return j()}if(typeof s.filter=="function"){const i=s.filter(l);l=z(l,F,"filter",g=>i.includes(g))}if(s.maxFiles!==void 0){let i=Q===!0?A.length:0;if(l=z(l,F,"max-files",()=>(i++,i<=k.value)),l.length===0)return j()}if(j(),l.length!==0)return l}function E(t){R(t),n.value!==!0&&(n.value=!0)}function o(t){te(t),(t.relatedTarget!==null||re.is.safari!==!0?t.relatedTarget!==C.value:document.elementsFromPoint(t.clientX,t.clientY).includes(C.value)===!1)===!0&&(n.value=!1)}function T(t){R(t);const S=t.dataTransfer.files;S.length!==0&&c(null,S),n.value=!1}function U(t){if(n.value===!0)return V("div",{ref:C,class:`q-${t}__dnd absolute-full`,onDragenter:R,onDragover:R,onDragleave:o,onDrop:T})}return Object.assign(v,{pickFiles:m,addFiles:B}),{pickFiles:m,addFiles:B,onDragover:E,onDragleave:o,processFiles:P,getDndNode:U,maxFilesNumber:k,maxTotalSizeNumber:d}}const Te=ue({name:"QFile",inheritAttrs:!1,props:{...oe,...ce,...Ne,modelValue:[File,FileList,Array],append:Boolean,useChips:Boolean,displayValue:[String,Number],tabindex:{type:[String,Number],default:0},counterLabel:Function,inputClass:[Array,String,Object],inputStyle:[Array,String,Object]},emits:[...fe,...Oe],setup(e,{slots:n,emit:h,attrs:c}){const{proxy:s}=ee(),u=de(),v=I(null),C=I(!1),p=me(e),{pickFiles:k,onDragover:d,onDragleave:m,processFiles:B,getDndNode:P}=Ie({editable:u.editable,dnd:C,getFileInput:H,addFilesToQueue:K}),E=ge(e),o=y(()=>Object(e.modelValue)===e.modelValue?"length"in e.modelValue?Array.from(e.modelValue):[e.modelValue]:[]),T=y(()=>M(o.value)),U=y(()=>o.value.map(a=>a.name).join(", ")),t=y(()=>Qe(o.value.reduce((a,b)=>a+b.size,0))),S=y(()=>({totalSize:t.value,filesNumber:o.value.length,maxFiles:e.maxFiles})),A=y(()=>({tabindex:-1,type:"file",title:"",accept:e.accept,capture:e.capture,name:p.value,...c,id:u.targetUid.value,disabled:u.editable.value!==!0})),Q=y(()=>"q-file q-field--auto-height"+(C.value===!0?" q-file--dnd":"")),l=y(()=>e.multiple===!0&&e.append===!0);function F(a){const b=o.value.slice();b.splice(a,1),i(b)}function j(a){const b=o.value.indexOf(a);b!==-1&&F(b)}function i(a){h("update:modelValue",e.multiple===!0?a:a[0])}function g(a){a.keyCode===13&&be(a)}function L(a){(a.keyCode===13||a.keyCode===32)&&k(a)}function H(){return v.value}function K(a,b){const _=B(a,b,o.value,l.value),q=H();q!=null&&(q.value=""),_!==void 0&&((e.multiple===!0?e.modelValue&&_.every(ie=>o.value.includes(ie)):e.modelValue===_[0])||i(l.value===!0?o.value.concat(_):_))}function D(){return[V("input",{class:[e.inputClass,"q-file__filler"],style:e.inputStyle})]}function ae(){if(n.file!==void 0)return o.value.length===0?D():o.value.map((b,_)=>n.file({index:_,file:b,ref:this}));if(n.selected!==void 0)return o.value.length===0?D():n.selected({files:o.value,ref:this});if(e.useChips===!0)return o.value.length===0?D():o.value.map((b,_)=>V(Ae,{key:"file-"+_,removable:u.editable.value,dense:!0,textColor:e.color,tabindex:e.tabindex,onRemove:()=>{F(_)}},()=>V("span",{class:"ellipsis",textContent:b.name})));const a=e.displayValue!==void 0?e.displayValue:U.value;return a.length!==0?[V("div",{class:e.inputClass,style:e.inputStyle,textContent:a})]:D()}function le(){const a={ref:v,...A.value,...E.value,class:"q-field__input fit absolute-full cursor-pointer",onChange:K};return e.multiple===!0&&(a.multiple=!0),V("input",a)}return Object.assign(u,{fieldClass:Q,emitValue:i,hasValue:T,inputRef:v,innerValue:o,floatingLabel:y(()=>T.value===!0||M(e.displayValue)),computedCounter:y(()=>{if(e.counterLabel!==void 0)return e.counterLabel(S.value);const a=e.maxFiles;return`${o.value.length}${a!==void 0?" / "+a:""} (${t.value})`}),getControlChild:()=>P("file"),getControl:()=>{const a={ref:u.targetRef,class:"q-field__native row items-center cursor-pointer",tabindex:e.tabindex};return u.editable.value===!0&&Object.assign(a,{onDragover:d,onDragleave:m,onKeydown:g,onKeyup:L}),V("div",a,[le()].concat(ae()))}}),Object.assign(s,{removeAtIndex:F,removeFile:j,getNativeElement:()=>v.value}),pe(s,"nativeEl",()=>v.value),ve(u)}});async function G(){return{settings:ne().settings,topics:await x.topics.where({byUser:1}).toArray(),entities:await x.entries.where({byUser:1}).toArray(),states:await x.states.toArray(),favorites:await x.favorites.toArray(),notes:await x.notes.toArray()}}function Z(e){const n=ne(),h=ye(),c=Fe(),s=he();if(e.settings)for(const u in n.settings)u in e.settings&&(n.settings[u]=e.settings[u]);e.topics&&(x.topics.bulkPut(e.topics),h.loadAll()),e.entities&&(x.entries.bulkPut(e.entities),c.loadSearchWords()),e.states&&x.states.bulkPut(e.favorites),e.favorites&&(x.favorites.bulkPut(e.favorites),s.loadAll()),e.notes&&x.notes.bulkPut(e.notes)}const De={__name:"BackupPage",setup(e,{expose:n}){n();const h=Y(),c=I(null);async function s(){const p=JSON.stringify(await G(),null,2),k=new Blob([p],{type:"application/json"}),d=document.createElement("a");d.href=URL.createObjectURL(k),d.download="phraserium-user-data.json",d.click(),URL.revokeObjectURL(d.href)}function u(){const p=new FileReader;p.onload=k=>{try{const d=JSON.parse(k.target.result);if(!d||!X.object(d))throw new Error("Пустые или невалидные данные");v(d)}catch(d){$.error("Ошибка при чтении файла: "+d.message)}},p.readAsText(c.value)}function v(p){const k=m=>p[m].length||Object.keys(p[m]).length,d=Object.keys(p);h.dialog({message:"Выберите данные для восстановления:",options:{type:"checkbox",model:d.filter(m=>k(m)),items:d.map(m=>({label:`${m} (${k(m)})`,value:m}))},cancel:!0,persistent:!0}).onOk(m=>{if(m.length){const B={};m.forEach(P=>B[P]=p[P]),Z(B),$.success("Данные загружены"),c.value=null}})}const C={$q:h,file:c,onCreateBackup:s,onRestoreBackup:u,selectBackup:v,ref:I,get is(){return X},get useQuasar(){return Y},get getBackupData(){return G},get restoreData(){return Z},get notify(){return $}};return Object.defineProperty(C,"__isScriptSetup",{enumerable:!1,value:!0}),C}};function Re(e,n,h,c,s,u){return xe(),Se(_e,null,[r(Be,{elevated:""},{default:f(()=>[r(Pe,null,{default:f(()=>[r(W,{flat:"",dense:"",round:"",icon:"arrow_back","aria-label":"Back",onClick:n[0]||(n[0]=v=>e.$router.back())}),r(ze,null,{default:f(()=>n[2]||(n[2]=[Ce("div",{class:"absolute-center"},"Backup",-1)])),_:1})]),_:1})]),_:1}),r(Ve,{padding:""},{default:f(()=>[r(we,{bordered:"",padding:""},{default:f(()=>[r(N,{header:""},{default:f(()=>n[3]||(n[3]=[w("Backup пользовательских данных")])),_:1}),r(J,null,{default:f(()=>[r(O,null,{default:f(()=>[r(N,null,{default:f(()=>n[4]||(n[4]=[w("Создать резервную копию")])),_:1}),r(N,{caption:""},{default:f(()=>n[5]||(n[5]=[w(" Будет создан и скачан файл .json со всеми пользовательскими данными ")])),_:1})]),_:1}),r(O,{side:""},{default:f(()=>[r(W,{onClick:c.onCreateBackup,icon:"save_alt",label:"Backup",color:"primary"})]),_:1})]),_:1}),r(J,null,{default:f(()=>[r(O,null,{default:f(()=>[r(N,null,{default:f(()=>n[6]||(n[6]=[w("Восстановить из резервной копии")])),_:1}),r(N,{caption:""},{default:f(()=>n[7]||(n[7]=[w(" Восстановление пользовательских данных из файла .json ")])),_:1})]),_:1})]),_:1}),r(J,null,{default:f(()=>[r(O,null,{default:f(()=>[r(Te,{modelValue:c.file,"onUpdate:modelValue":n[1]||(n[1]=v=>c.file=v),accept:".json","max-file-size":"1048576",label:c.file?void 0:"Выберите файл...",clearable:"",outlined:"",dense:""},{prepend:f(()=>[r(je,{name:"attach_file"})]),_:1},8,["modelValue","label"])]),_:1}),r(O,{side:""},{default:f(()=>[r(W,{onClick:c.onRestoreBackup,disable:!c.file,icon:"upload_file",label:"Restore",color:"primary"},null,8,["disable"])]),_:1})]),_:1})]),_:1})]),_:1})],64)}const Ke=ke(De,[["render",Re],["__file","BackupPage.vue"]]);export{Ke as default};
