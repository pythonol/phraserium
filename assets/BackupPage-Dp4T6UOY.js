import{t as O,b as y,g as ee,aQ as re,ae as te,a9 as se,h as B,a as ue,bC as oe,bb as ce,b6 as fe,b8 as de,bc as me,bD as ge,bE as pe,b7 as ve,be as X,aR as be,A as ne,bl as x,ay as ye,_ as Fe,G as he,F as r,E as c,H as ke,b2 as Y,bF as $,D as _e,Q as W,I as Se,N as A,a7 as xe}from"./index-BGy2oowu.js";import{Q as Ce,a as je,b as Ve,c as Be}from"./QPage-kfsnINns.js";import{b as w,a as H,Q as D}from"./QItem-DUVg4lhN.js";import{Q as Pe}from"./QChip-DtIzeSyW.js";import{h as Qe}from"./format-CJebrXOQ.js";import{Q as ze}from"./QList-D-FZbtE7.js";import{u as G}from"./use-quasar-BiL6YFO2.js";import"./QResizeObserver-DF-ichTx.js";function Q(e,n,h,s){const u=[];return e.forEach(d=>{s(d)===!0?u.push(d):n.push({failedPropValidation:h,file:d})}),u}function R(e){e&&e.dataTransfer&&(e.dataTransfer.dropEffect="copy"),te(e)}const Ne={multiple:Boolean,accept:String,capture:String,maxFileSize:[Number,String],maxTotalSize:[Number,String],maxFiles:[Number,String],filter:Function},Ae=["rejected"];function we({editable:e,dnd:n,getFileInput:h,addFilesToQueue:s}){const{props:u,emit:d,proxy:v}=ee(),C=O(null),p=y(()=>u.accept!==void 0?u.accept.split(",").map(t=>(t=t.trim(),t==="*"?"*/":(t.endsWith("/*")&&(t=t.slice(0,t.length-1)),t.toUpperCase()))):null),k=y(()=>parseInt(u.maxFiles,10)),f=y(()=>parseInt(u.maxTotalSize,10));function m(t){if(e.value)if(t!==Object(t)&&(t={target:null}),t.target!==null&&t.target.matches('input[type="file"]')===!0)t.clientX===0&&t.clientY===0&&re(t);else{const _=h();_&&_!==t.target&&_.click(t)}}function V(t){e.value&&t&&s(null,t)}function P(t,_,z,N){let l=Array.from(_||t.target.files);const F=[],j=()=>{F.length!==0&&d("rejected",F)};if(u.accept!==void 0&&p.value.indexOf("*/")===-1&&(l=Q(l,F,"accept",i=>p.value.some(g=>i.type.toUpperCase().startsWith(g)||i.name.toUpperCase().endsWith(g))),l.length===0))return j();if(u.maxFileSize!==void 0){const i=parseInt(u.maxFileSize,10);if(l=Q(l,F,"max-file-size",g=>g.size<=i),l.length===0)return j()}if(u.multiple!==!0&&l.length!==0&&(l=[l[0]]),l.forEach(i=>{i.__key=i.webkitRelativePath+i.lastModified+i.name+i.size}),N===!0){const i=z.map(g=>g.__key);l=Q(l,F,"duplicate",g=>i.includes(g.__key)===!1)}if(l.length===0)return j();if(u.maxTotalSize!==void 0){let i=N===!0?z.reduce((g,L)=>g+L.size,0):0;if(l=Q(l,F,"max-total-size",g=>(i+=g.size,i<=f.value)),l.length===0)return j()}if(typeof u.filter=="function"){const i=u.filter(l);l=Q(l,F,"filter",g=>i.includes(g))}if(u.maxFiles!==void 0){let i=N===!0?z.length:0;if(l=Q(l,F,"max-files",()=>(i++,i<=k.value)),l.length===0)return j()}if(j(),l.length!==0)return l}function T(t){R(t),n.value!==!0&&(n.value=!0)}function o(t){te(t),(t.relatedTarget!==null||se.is.safari!==!0?t.relatedTarget!==C.value:document.elementsFromPoint(t.clientX,t.clientY).includes(C.value)===!1)===!0&&(n.value=!1)}function I(t){R(t);const _=t.dataTransfer.files;_.length!==0&&s(null,_),n.value=!1}function U(t){if(n.value===!0)return B("div",{ref:C,class:`q-${t}__dnd absolute-full`,onDragenter:R,onDragover:R,onDragleave:o,onDrop:I})}return Object.assign(v,{pickFiles:m,addFiles:V}),{pickFiles:m,addFiles:V,onDragover:T,onDragleave:o,processFiles:P,getDndNode:U,maxFilesNumber:k,maxTotalSizeNumber:f}}const De=ue({name:"QFile",inheritAttrs:!1,props:{...oe,...ce,...Ne,modelValue:[File,FileList,Array],append:Boolean,useChips:Boolean,displayValue:[String,Number],tabindex:{type:[String,Number],default:0},counterLabel:Function,inputClass:[Array,String,Object],inputStyle:[Array,String,Object]},emits:[...fe,...Ae],setup(e,{slots:n,emit:h,attrs:s}){const{proxy:u}=ee(),d=de(),v=O(null),C=O(!1),p=me(e),{pickFiles:k,onDragover:f,onDragleave:m,processFiles:V,getDndNode:P}=we({editable:d.editable,dnd:C,getFileInput:J,addFilesToQueue:M}),T=ge(e),o=y(()=>Object(e.modelValue)===e.modelValue?"length"in e.modelValue?Array.from(e.modelValue):[e.modelValue]:[]),I=y(()=>X(o.value)),U=y(()=>o.value.map(a=>a.name).join(", ")),t=y(()=>Qe(o.value.reduce((a,b)=>a+b.size,0))),_=y(()=>({totalSize:t.value,filesNumber:o.value.length,maxFiles:e.maxFiles})),z=y(()=>({tabindex:-1,type:"file",title:"",accept:e.accept,capture:e.capture,name:p.value,...s,id:d.targetUid.value,disabled:d.editable.value!==!0})),N=y(()=>"q-file q-field--auto-height"+(C.value===!0?" q-file--dnd":"")),l=y(()=>e.multiple===!0&&e.append===!0);function F(a){const b=o.value.slice();b.splice(a,1),i(b)}function j(a){const b=o.value.indexOf(a);b!==-1&&F(b)}function i(a){h("update:modelValue",e.multiple===!0?a:a[0])}function g(a){a.keyCode===13&&be(a)}function L(a){(a.keyCode===13||a.keyCode===32)&&k(a)}function J(){return v.value}function M(a,b){const S=V(a,b,o.value,l.value),q=J();q!=null&&(q.value=""),S!==void 0&&((e.multiple===!0?e.modelValue&&S.every(ie=>o.value.includes(ie)):e.modelValue===S[0])||i(l.value===!0?o.value.concat(S):S))}function E(){return[B("input",{class:[e.inputClass,"q-file__filler"],style:e.inputStyle})]}function ae(){if(n.file!==void 0)return o.value.length===0?E():o.value.map((b,S)=>n.file({index:S,file:b,ref:this}));if(n.selected!==void 0)return o.value.length===0?E():n.selected({files:o.value,ref:this});if(e.useChips===!0)return o.value.length===0?E():o.value.map((b,S)=>B(Pe,{key:"file-"+S,removable:d.editable.value,dense:!0,textColor:e.color,tabindex:e.tabindex,onRemove:()=>{F(S)}},()=>B("span",{class:"ellipsis",textContent:b.name})));const a=e.displayValue!==void 0?e.displayValue:U.value;return a.length!==0?[B("div",{class:e.inputClass,style:e.inputStyle,textContent:a})]:E()}function le(){const a={ref:v,...z.value,...T.value,class:"q-field__input fit absolute-full cursor-pointer",onChange:M};return e.multiple===!0&&(a.multiple=!0),B("input",a)}return Object.assign(d,{fieldClass:N,emitValue:i,hasValue:I,inputRef:v,innerValue:o,floatingLabel:y(()=>I.value===!0||X(e.displayValue)),computedCounter:y(()=>{if(e.counterLabel!==void 0)return e.counterLabel(_.value);const a=e.maxFiles;return`${o.value.length}${a!==void 0?" / "+a:""} (${t.value})`}),getControlChild:()=>P("file"),getControl:()=>{const a={ref:d.targetRef,class:"q-field__native row items-center cursor-pointer",tabindex:e.tabindex};return d.editable.value===!0&&Object.assign(a,{onDragover:f,onDragleave:m,onKeydown:g,onKeyup:L}),B("div",a,[le()].concat(ae()))}}),Object.assign(u,{removeAtIndex:F,removeFile:j,getNativeElement:()=>v.value}),pe(u,"nativeEl",()=>v.value),ve(d)}});async function K(){return{settings:ne().settings,topics:await x.topics.where({byUser:1}).toArray(),entities:await x.entries.where({byUser:1}).toArray(),states:await x.states.toArray(),favorites:await x.favorites.toArray(),notes:await x.notes.toArray()}}function Z(e){const n=ne(),h=ye();if(e.settings)for(const s in n.settings)s in e.settings&&(n.settings[s]=e.settings[s]);e.topics&&x.topics.bulkPut(e.topics),e.entities&&(x.entries.bulkPut(e.entities),h.loadSearchWords()),e.states&&x.states.bulkPut(e.favorites),e.favorites&&x.favorites.bulkPut(e.favorites),e.notes&&x.notes.bulkPut(e.notes)}const Oe={__name:"BackupPage",setup(e,{expose:n}){n();const h=G(),s=O(null);async function u(){const p=JSON.stringify(await K(),null,2),k=new Blob([p],{type:"application/json"}),f=document.createElement("a");f.href=URL.createObjectURL(k),f.download="phraserium-user-data.json",f.click(),URL.revokeObjectURL(f.href)}function d(){const p=new FileReader;p.onload=k=>{try{const f=JSON.parse(k.target.result);if(!f||!Y.object(f))throw new Error("Пустые или невалидные данные");v(f)}catch(f){$.error("Ошибка при чтении файла: "+f.message)}},p.readAsText(s.value)}function v(p){const k=m=>p[m].length||Object.keys(p[m]).length,f=Object.keys(p);h.dialog({message:"Выберите данные для восстановления:",options:{type:"checkbox",model:f.filter(m=>k(m)),items:f.map(m=>({label:`${m} (${k(m)})`,value:m}))},cancel:!0,persistent:!0}).onOk(m=>{if(m.length){const V={};m.forEach(P=>V[P]=p[P]),Z(V),$.success("Данные загружены"),s.value=null}})}const C={$q:h,file:s,onCreateBackup:u,onRestoreBackup:d,selectBackup:v,ref:O,get is(){return Y},get useQuasar(){return G},get getBackupData(){return K},get restoreData(){return Z},get notify(){return $}};return Object.defineProperty(C,"__isScriptSetup",{enumerable:!1,value:!0}),C}};function Ie(e,n,h,s,u,d){return _e(),he(ke,null,[r(Ce,{elevated:""},{default:c(()=>[r(Ve,null,{default:c(()=>[r(W,{flat:"",dense:"",round:"",icon:"arrow_back","aria-label":"Back",onClick:n[0]||(n[0]=v=>e.$router.back())}),r(Be,null,{default:c(()=>n[2]||(n[2]=[Se("div",{class:"absolute-center"},"Backup",-1)])),_:1})]),_:1})]),_:1}),r(je,{padding:""},{default:c(()=>[r(ze,{bordered:"",padding:""},{default:c(()=>[r(w,{header:""},{default:c(()=>n[3]||(n[3]=[A("Backup пользовательских данных")])),_:1}),r(H,null,{default:c(()=>[r(D,null,{default:c(()=>[r(w,null,{default:c(()=>n[4]||(n[4]=[A("Создать резервную копию")])),_:1}),r(w,{caption:""},{default:c(()=>n[5]||(n[5]=[A(" Будет создан и скачан файл .json со всеми пользовательскими данными ")])),_:1})]),_:1}),r(D,{side:""},{default:c(()=>[r(W,{onClick:s.onCreateBackup,icon:"save_alt",label:"Backup",color:"primary"})]),_:1})]),_:1}),r(H,null,{default:c(()=>[r(D,null,{default:c(()=>[r(w,null,{default:c(()=>n[6]||(n[6]=[A("Восстановить из резервной копии")])),_:1}),r(w,{caption:""},{default:c(()=>n[7]||(n[7]=[A(" Восстановление пользовательских данных из файла .json ")])),_:1})]),_:1})]),_:1}),r(H,null,{default:c(()=>[r(D,null,{default:c(()=>[r(De,{modelValue:s.file,"onUpdate:modelValue":n[1]||(n[1]=v=>s.file=v),accept:".json","max-file-size":"1048576",label:s.file?void 0:"Выберите файл...",clearable:"",outlined:"",dense:""},{prepend:c(()=>[r(xe,{name:"attach_file"})]),_:1},8,["modelValue","label"])]),_:1}),r(D,{side:""},{default:c(()=>[r(W,{onClick:s.onRestoreBackup,disable:!s.file,icon:"upload_file",label:"Restore",color:"primary"},null,8,["disable"])]),_:1})]),_:1})]),_:1})]),_:1})],64)}const He=Fe(Oe,[["render",Ie],["__file","BackupPage.vue"]]);export{He as default};
